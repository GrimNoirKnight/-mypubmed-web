<!-- 
  index.html
  My PubMed Research Assistant

  Created by Alan D. Keizer
  © 2025 Alan. D. Keizer. All rights reserved.

  Description:
  A browser-based frontend that fetches PubMed article data using E-Utilities (esearch & efetch),
  with fallback support for plain-text metadata parsing from /?format=pubmed endpoints.

  Version: 00.003.025-alpha

  Change Log:
  - Debug logger added beneath results panel
  - Fixed all instances of stuck "Loading..." bug
  - All buttons now behave as expected (no more auto-trigger)
  - README corrected to match required field schema
  - Footer shows version + attribution
  - Improved fallback error handling
  - UI consistency improvements

  Required Fields for Rendering: (pmid, title, authors, journal, pubDate)
  
    Attribute Name     | Type    | Optional | Notes
  ---------------------+---------+----------+--------------------------------------------------------
  pmid                 | String  | No       | Primary PubMed Identifier
  title                | String  | No       | Article title (always available)
  authors              | String  | No       | Author list, formatted as a readable string
  journal              | String  | No       | Journal name where article was published
  pubDate              | Date    | No       | Publication year or full date string

  Optional Fields for Rendering:

    Attribute Name     | Type    | Optional | Notes
  ---------------------+---------+----------+--------------------------------------------------------
  abstract             | String  | Yes      | Abstract text
  affiliations         | String  | Yes      | Author affiliations
  conflictOfInterest   | String  | Yes      | Conflict of interest statement
  dateSaved            | Date    | Yes      | When article was saved
  doi                  | String  | Yes      | Digital Object Identifier
  fullTextAvailable    | Boolean | Yes      | True/False flag
  funding              | String  | Yes      | Funding sources
  issue                | String  | Yes      | Issue number
  keywords             | String  | Yes      | Keywords (comma-separated)
  meSHterms            | String  | Yes      | Medical Subject Headings (comma-separated)
  pages                | String  | Yes      | Page numbers
  pmcid                | String  | Yes      | Optional identifier
  volume               | String  | Yes      | Volume number
  webLink              | String  | Yes      | Link to article
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My PubMed Research Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #FFFFFF;
      color: #3C3B6E;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #3C3B6E;
      color: #FFFFFF;
      padding: 30px 20px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 2em;
    }

    header p {
      font-size: 1.1em;
      font-weight: 300;
      margin-top: 8px;
    }

    main {
      padding: 30px 20px;
      max-width: 900px;
      margin: auto;
    }

    input[type="text"] {
      padding: 10px;
      font-size: 16px;
      width: 60%;
      border: 2px solid #B22234;
      color: #3C3B6E;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      background-color: #B22234;
      color: white;
      border: none;
      cursor: pointer;
      margin-left: 10px;
    }

    button:hover {
      background-color: #8b1a25;
    }

    .save-button {
      background-color: transparent;
      border: 2px solid #B22234;
      color: #B22234;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 5px;
    }

    .save-button:hover {
      background-color: #B22234;
      color: white;
    }

    .controls {
      margin-bottom: 20px;
    }

    .result {
      margin-bottom: 30px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 20px;
    }

    .label {
      font-weight: bold;
    }

    a {
      color: #B22234;
      text-decoration: underline;
    }

    #results-count {
      font-weight: bold;
      margin-bottom: 15px;
    }

    footer {
      background-color: #f1f1f1;
      padding: 20px;
      text-align: center;
      color: #3C3B6E;
      border-top: 2px solid #B22234;
      font-size: 0.95em;
    }

    footer a {
      color: #3C3B6E;
      text-decoration: none;
      font-weight: bold;
    }

    footer a:hover {
      text-decoration: underline;
    }

    #readme {
      margin-top: 40px;
      padding-top: 10px;
      border-top: 2px solid #B22234;
    }

    table {
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
    }

    th {
      background-color: #eee;
    }

    #debugLog {
      margin-top: 40px;
      padding: 10px;
      border-top: 2px solid #3C3B6E;
      background: #f8f8f8;
      font-size: 13px;
      line-height: 1.4em;
      white-space: pre-wrap;
    }

    .debug-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>My PubMed Research Assistant</h1>
    <p>Your fast, AI-ready tool for exploring medical research!</p>
  </header>

  <main>
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search PubMed...">
      <button onclick="searchPubMed()">Search</button>
      <button onclick="showSavedArticles()">View Saved Articles</button>
      <button onclick="toggleReadme()">Show README</button>
      <label style="margin-left: 15px;">
        <input type="checkbox" id="filterStrict"> Require All Metadata
      </label>
      <label style="margin-left: 10px;">
        <input type="checkbox" id="usePlainText"> Use Plain-Text Fallback
      </label>
    </div>

    <div id="results-count">Ready.</div>
    <div id="results">Waiting for search...</div>

    <div id="readme" style="display:none;">
      <h2>README: Attribute Reference Table</h2>
      <table>
        <thead>
          <tr>
            <th>Attribute Name</th><th>Type</th><th>Optional</th><th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>pmid</td><td>String</td><td>No</td><td>Primary PubMed Identifier</td></tr>
          <tr><td>title</td><td>String</td><td>No</td><td>Always present</td></tr>
          <tr><td>authors</td><td>String</td><td>No</td><td>Author list</td></tr>
          <tr><td>journal</td><td>String</td><td>No</td><td>Journal name</td></tr>
          <tr><td>pubDate</td><td>Date</td><td>No</td><td>Publication date</td></tr>
          <tr><td>abstract</td><td>String</td><td>Yes</td><td>May be missing in older records</td></tr>
          <tr><td>fullTextAvailable</td><td>Boolean</td><td>Yes</td><td>True if in PMC</td></tr>
          <tr><td>doi</td><td>String</td><td>Yes</td><td>Optional DOI</td></tr>
          <tr><td>pmcid</td><td>String</td><td>Yes</td><td>PMC Identifier</td></tr>
        </tbody>
      </table>
    </div>

    <div id="debugLog">
      <div class="debug-label">Debug Log:</div>
      <div id="debugContent">(nothing yet)</div>
    </div>
  </main>

  <footer>
    &copy; 2025 MyPubMedResearchAssistant.com v00.003.025 — Powered by Cats | Created by Clean Kitty Development
  </footer>

  <!-- Scripts will be appended here in final part -->
</body>
</html>
<script>
  const debug = msg => {
    const box = document.getElementById("debugContent");
    box.textContent += `\n> ${msg}`;
  };

  function formatDate(date) {
    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function getSavedArticles() {
    const saved = localStorage.getItem('savedArticles');
    return saved ? JSON.parse(saved) : {};
  }

  function saveArticle(pmid) {
    const saved = getSavedArticles();
    if (!saved[pmid]) {
      saved[pmid] = { dateSaved: new Date().toISOString() };
      localStorage.setItem('savedArticles', JSON.stringify(saved));
      debug(`Saved article ${pmid}`);
      searchPubMed();
    }
  }

  function removeArticle(pmid) {
    const saved = getSavedArticles();
    if (saved[pmid]) {
      delete saved[pmid];
      localStorage.setItem('savedArticles', JSON.stringify(saved));
      debug(`Removed article ${pmid}`);
      searchPubMed();
    }
  }

  function toggleReadme() {
    const readme = document.getElementById('readme');
    readme.style.display = readme.style.display === 'block' ? 'none' : 'block';
  }

  function getInputStates() {
    return {
      strictMode: document.getElementById('filterStrict').checked,
      usePlain: document.getElementById('usePlainText').checked,
      term: document.getElementById('searchInput').value.trim()
    };
  }

  async function searchPubMed() {
    const { term, usePlain, strictMode } = getInputStates();
    const savedArticles = getSavedArticles();
    const resultsDiv = document.getElementById("results");
    const resultsCount = document.getElementById("results-count");
    resultsDiv.innerHTML = "Loading...";
    resultsCount.textContent = "Searching...";
    document.getElementById("debugContent").textContent = "";

    if (!term) {
      resultsDiv.innerHTML = "Please enter a search term.";
      return;
    }

    try {
      const searchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&retmax=100&term=${encodeURIComponent(term)}`;
      debug(`Searching PubMed for: ${term}`);
      const searchRes = await fetch(searchUrl);
      const searchData = await searchRes.json();
      const idList = searchData.esearchresult.idlist;

      if (!idList.length) {
        debug(`No results for "${term}"`);
        resultsDiv.innerHTML = "No results.";
        resultsCount.textContent = "Articles Found: 0";
        return;
      }

      debug(`Found ${idList.length} IDs`);
      await renderArticles(idList, savedArticles, resultsDiv, resultsCount, strictMode, usePlain);
    } catch (err) {
      debug(`Error: ${err.message}`);
      resultsDiv.innerHTML = "An error occurred.";
    }
  }

  async function showSavedArticles() {
    const pmids = Object.keys(getSavedArticles());
    const resultsDiv = document.getElementById("results");
    const resultsCount = document.getElementById("results-count");
    resultsDiv.innerHTML = "Loading saved articles...";
    debug(`Loading saved articles (${pmids.length})`);
    await renderArticles(pmids, getSavedArticles(), resultsDiv, resultsCount, false, false);
  }

  async function renderArticles(idList, savedArticles, resultsDiv, resultsCount, strictMode, usePlain) {
    let html = "", count = 0;
    for (let i = 0; i < idList.length; i++) {
      const pmid = idList[i];
      debug(`Fetching: ${pmid} ${usePlain ? "(fallback)" : "(xml)"}`);

      let data = usePlain ? await fetchPlainText(pmid) : await fetchXML(pmid);
      if (!data || !data.pmid || !data.title || !data.authors || !data.journal || !data.pubDate) {
        if (strictMode) continue;
      }

      const score = Object.values(data).filter(Boolean).length;
      const total = 15;
      const scorePercent = Math.round(score / total * 100);

      html += `
        <div class="result">
          <h3>${++count}. ${data.title}</h3>
          <p><span class="label">PMID:</span> ${pmid}</p>
          <p><span class="label">Authors:</span> ${data.authors || "Unknown"}</p>
          <p><span class="label">Journal:</span> ${data.journal || "Unknown"}</p>
          <p><span class="label">Date:</span> ${data.pubDate || "Unknown"}</p>
          <p><span class="label">Abstract:</span> ${data.abstract || "No abstract available."}</p>
          <p><span class="label">Metadata Score:</span> ${score}/${total} (${scorePercent}%)</p>
          <p><span class="label">Date Saved:</span> ${
            savedArticles[pmid]?.dateSaved
              ? `${formatDate(new Date(savedArticles[pmid].dateSaved))} 
                <button class="save-button" onclick="removeArticle('${pmid}')">Remove from Saved</button>`
              : `<button class="save-button" onclick="saveArticle('${pmid}')">Save Article</button>`
          }</p>
          <p><a href="https://pubmed.ncbi.nlm.nih.gov/${pmid}/" target="_blank">View on PubMed</a></p>
        </div>
      `;
    }

    resultsDiv.innerHTML = html || "No articles matched.";
    resultsCount.textContent = `Articles Found: ${count}`;
  }

  async function fetchXML(pmid) {
    try {
      const res = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmid}&retmode=xml`);
      const text = await res.text();
      const doc = new DOMParser().parseFromString(text, "text/xml");
      const article = doc.querySelector("PubmedArticle");

      const title = article?.querySelector("ArticleTitle")?.textContent || "";
      const authors = Array.from(article.querySelectorAll("Author")).map(a => {
        const last = a.querySelector("LastName")?.textContent || "";
        const fore = a.querySelector("ForeName")?.textContent || "";
        return `${fore} ${last}`.trim();
      }).join(", ");
      const abstract = article?.querySelector("AbstractText")?.textContent || "";
      const journal = article?.querySelector("Journal > Title")?.textContent || "";
      const pubDate = article?.querySelector("PubDate")?.textContent || "";

      return { pmid, title, authors, abstract, journal, pubDate };
    } catch (err) {
      debug(`XML fetch error for ${pmid}: ${err.message}`);
      return null;
    }
  }

  async function fetchPlainText(pmid) {
    try {
      const res = await fetch(`https://pubmed.ncbi.nlm.nih.gov/${pmid}/?format=pubmed`);
      const text = await res.text();
      const lines = text.split("\n");

      const getField = tag => {
        const line = lines.find(l => l.startsWith(tag + " - "));
        return line ? line.replace(`${tag} - `, "").trim() : "";
      };

      const authors = lines.filter(l => l.startsWith("FAU -")).map(l => l.replace("FAU - ", "")).join(", ");
      const title = getField("TI");
      const abstract = getField("AB");
      const journal = getField("JT");
      const pubDate = getField("DP");

      return { pmid, title, authors, abstract, journal, pubDate };
    } catch (err) {
      debug(`Plain-text fetch error for ${pmid}: ${err.message}`);
      return null;
    }
  }

  // Enable pressing Enter to search
  document.getElementById("searchInput").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      searchPubMed();
    }
  });
</script>